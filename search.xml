<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[Android ä¸¢å¸§åŸç†ä»¥åŠåŠæ³•]]></title>
      <url>/2017/01/22/Android%20%E4%B8%A2%E5%B8%A7%E5%8E%9F%E7%90%86%E4%BB%A5%E5%8F%8A%E5%8A%9E%E6%B3%95/</url>
      <content type="html"><![CDATA[<h2 id="æ¥è¿‘å¹´åº•ï¼Œæƒ³åˆ†äº«ç‚¹å„¿ä¸œè¥¿ç»™å¤§å®¶ã€‚"><a href="#æ¥è¿‘å¹´åº•ï¼Œæƒ³åˆ†äº«ç‚¹å„¿ä¸œè¥¿ç»™å¤§å®¶ã€‚" class="headerlink" title="æ¥è¿‘å¹´åº•ï¼Œæƒ³åˆ†äº«ç‚¹å„¿ä¸œè¥¿ç»™å¤§å®¶ã€‚"></a>æ¥è¿‘å¹´åº•ï¼Œæƒ³åˆ†äº«ç‚¹å„¿ä¸œè¥¿ç»™å¤§å®¶ã€‚</h2><h2 id="Android-UIç»˜åˆ¶è¿‡ç¨‹"><a href="#Android-UIç»˜åˆ¶è¿‡ç¨‹" class="headerlink" title="Android UIç»˜åˆ¶è¿‡ç¨‹"></a>Android UIç»˜åˆ¶è¿‡ç¨‹</h2><p>å¼€å‘ä¸­çš„å¡é¡¿æˆ‘æƒ³æ²¡è·Ÿäººéƒ½é‡åˆ°è¿‡ï¼Œä¹‹å‰ä¹Ÿæ˜¯æœåšå®¢çœ‹çœ‹æ€ä¹ˆä¸ªè§£å†³åŠæ³•ï¼Œæ²¡æœ‰è®¤çœŸç ”ç©¶è¿‡ï¼Œä»Šå¤©æˆ‘æ‰“ç®—è·Ÿå¤§å®¶èŠä¸€èŠã€‚</p>
<p>å…ˆä»View è¯´å§ã€‚ç›¸ä¿¡å¤§å®¶åº”è¯¥éƒ½çŸ¥é“Viewçš„ç»˜åˆ¶è¿‡ç¨‹ï¼Œmeasureï¼Œlayoutï¼Œdrawã€‚ä¸¢å¸§ä¸€å®šæ˜¯åœ¨16mså†…æ²¡æœ‰æŠŠè¿™äº›äº‹å„¿å¹²å®Œå°±å¯¹äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•çš„åˆ†ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯è®¡ç®—æ—¶é—´ï¼Œä»¥åŠç»˜å›¾æ—¶é—´ã€‚</p>
<p>è®¡ç®—æ—¶é—´ï¼šè¿™é‡Œçš„measureï¼Œlayoutçš„è¿‡ç¨‹ï¼Œéƒ½æ˜¯ä¼šå‘ä¸‹é€’å½’è®¡ç®—çš„ï¼Œå­¦è¿‡æ•°æ®ç»“æ„çš„è¯ï¼Œåº”è¯¥çŸ¥é“ï¼Œæ·±æœçš„ä»£ä»·æ˜¯å¾ˆå¤§çš„ã€‚æ‰€ä»¥å°½é‡è®©æ ‘çš„é«˜åº¦é™ä½ï¼Œè¿™é‡Œå°±å¼•å‡ºæ‰å¹³åŒ–å¸ƒå±€ã€‚</p>
<p>ç»˜å›¾æ—¶é—´ï¼šè¿™é‡Œéœ€è¦ç€é‡è®²ä¸€ä¸‹ï¼Œå› ä¸ºæœ‰æ—¶å€™è¿™æ‰æ˜¯æˆ‘ä»¬UIå¡é¡¿çš„ä¸»è¦åŸå› ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬è¦æŠŠandroidçš„è¯•å›¾çœ‹æˆæ˜¯ä¸‰ç»´çš„ï¼Œå°±åƒphotoshopçš„å›¾å±‚ä¸€æ ·ã€‚androidåœ¨ç»˜åˆ¶çš„æ—¶å€™å°±ä¼šä¸€å±‚ä¸€å±‚çš„â€œç²‰åˆ·â€ï¼Œå¥½äº†ï¼Œé‚£ä¹ˆé€ æˆå¡é¡¿ï¼Œä¹Ÿå°±æ˜¯ä¸¢å¸§ï¼Œè¯´ç™½äº†æœ€åæ²¡æœ‰åœ¨16mså†…åšå®Œã€‚å¥½äº†ï¼Œè®©æˆ‘ä»¬å‰–æä¸€ä¸‹ï¼š</p>
<h3 id="invalidate-ï¼š"><a href="#invalidate-ï¼š" class="headerlink" title="invalidate()ï¼š"></a>invalidate()ï¼š</h3><p>æˆ‘ä»¬çŸ¥é“invalidate æ˜¯ç”¨æ¥è¯·æ±‚View é‡ç»˜çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Propagate the damage rectangle to the parent view.</span></div><div class="line"><span class="keyword">final</span> AttachInfo ai = mAttachInfo;</div><div class="line"><span class="keyword">final</span> ViewParent p = mParent;</div><div class="line"><span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; ai != <span class="keyword">null</span> &amp;&amp; l &lt; r &amp;&amp; t &lt; b) &#123;</div><div class="line">    <span class="keyword">final</span> Rect damage = ai.mTmpInvalRect;</div><div class="line">    damage.set(l, t, r, b);</div><div class="line">    p.invalidateChild(<span class="keyword">this</span>, damage);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>invalidateInternal<br>è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥drawçš„è¿‡ç¨‹å…¶å®å°±æ˜¯æ‹¿åˆ°AttachInfo é‡Œé¢åŒ…å«ç€ç»˜åˆ¶ä¿¡æ¯ï¼Œä»¥åŠå°†ç»˜åˆ¶åŒºåŸŸæ‹¿åˆ°ï¼Œé€šè¿‡parentå»ç»˜åˆ¶ã€‚è®©æˆ‘ä»¬è·Ÿè¿›å»ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ViewParent <span class="title">invalidateChildInParent</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span>[] location, <span class="keyword">final</span> Rect dirty)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> ((mPrivateFlags &amp; PFLAG_DRAWN) == PFLAG_DRAWN ||</div><div class="line">            (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID) &#123;</div><div class="line">        <span class="keyword">if</span> ((mGroupFlags &amp; (FLAG_OPTIMIZE_INVALIDATE | FLAG_ANIMATION_DONE)) !=</div><div class="line">                    FLAG_OPTIMIZE_INVALIDATE) &#123;</div><div class="line">            dirty.offset(location[CHILD_LEFT_INDEX] - mScrollX,</div><div class="line">                    location[CHILD_TOP_INDEX] - mScrollY);</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; FLAG_CLIP_CHILDREN) == <span class="number">0</span>) &#123;</div><div class="line">                dirty.union(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> left = mLeft;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> top = mTop;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; FLAG_CLIP_CHILDREN) == FLAG_CLIP_CHILDREN) &#123;</div><div class="line">                <span class="keyword">if</span> (!dirty.intersect(<span class="number">0</span>, <span class="number">0</span>, mRight - left, mBottom - top)) &#123;</div><div class="line">                    dirty.setEmpty();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;</div><div class="line"></div><div class="line">            location[CHILD_LEFT_INDEX] = left;</div><div class="line">            location[CHILD_TOP_INDEX] = top;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mLayerType != LAYER_TYPE_NONE) &#123;</div><div class="line">                mPrivateFlags |= PFLAG_INVALIDATED;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> mParent;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mPrivateFlags &amp;= ~PFLAG_DRAWN &amp; ~PFLAG_DRAWING_CACHE_VALID;</div><div class="line"></div><div class="line">            location[CHILD_LEFT_INDEX] = mLeft;</div><div class="line">            location[CHILD_TOP_INDEX] = mTop;</div><div class="line">            <span class="keyword">if</span> ((mGroupFlags &amp; FLAG_CLIP_CHILDREN) == FLAG_CLIP_CHILDREN) &#123;</div><div class="line">                dirty.set(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// in case the dirty rect extends outside the bounds of this container</span></div><div class="line">                dirty.union(<span class="number">0</span>, <span class="number">0</span>, mRight - mLeft, mBottom - mTop);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mLayerType != LAYER_TYPE_NONE) &#123;</div><div class="line">                mPrivateFlags |= PFLAG_INVALIDATED;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> mParent;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>invalidateChildInParent<br>è¿™é‡Œçš„dirtyä»£è¡¨ä½ ç»˜åˆ¶çš„è¿™å—åŒºåŸŸæ˜¯å¦é€æ˜ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">invalidate</span><span class="params">()</span> </span>&#123;</div><div class="line">    mDirty.set(<span class="number">0</span>, <span class="number">0</span>, mWidth, mHeight);</div><div class="line">    <span class="keyword">if</span> (!mWillDrawSoon) &#123;</div><div class="line">        scheduleTraversals();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>invalidate<br>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸ªå…³é”®å‡½æ•° scheduleTraversals ï¼Œä¸ºä»€ä¹ˆè¯´ç¥å¥‡ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mTraversalScheduled) &#123;</div><div class="line">        mTraversalScheduled = <span class="keyword">true</span>;</div><div class="line">        mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</div><div class="line">        mChoreographer.postCallback(</div><div class="line">                Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</div><div class="line">        <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</div><div class="line">            scheduleConsumeBatchedInput();</div><div class="line">        &#125;</div><div class="line">        notifyRendererOfFramePending();</div><div class="line">        pokeDrawLockIfNeeded();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>scheduleTraversals<br>è¿™é‡Œæœ€é‡è¦çš„æ˜¯Choreographer è¿™ä¸ªï¼Œæˆ‘ä»¬æœ€ç»ˆç®—å‡ºæ¥çš„ç»˜åˆ¶ä¿¡æ¯éƒ½è¦é€šè¿‡å®ƒå›è°ƒï¼Œå¼€å§‹ä»–ä¼šæ³¨å†Œä¸€ä¸ªå¹¿æ’­ç”¨æ¥æ¥æ”¶æ—¶é’Ÿä¿¡æ¯ï¼Œç„¶åä»–ä¼šåœ¨å†…éƒ¨å»ºç«‹ä¸€ä¸ªUIç»˜åˆ¶é˜Ÿåˆ—ï¼šCallbackQueueï¼Œæˆ‘ä»¬åœ¨å¤–éƒ¨CallBackçš„æ—¶å€™ï¼Œä¼šå°†æˆ‘ä»¬çš„ç»˜åˆ¶ä¿¡æ¯ä½œä¸ºCallbackRecord ç„¶åä¼šåœ¨æ¥æ”¶åˆ°ä¸€ä¸ªæ—¶é’Ÿä¿¡å·çš„æ—¶å€™è¿›è¡ŒdoFrameæ“ä½œï¼Œå¹¶æ‰“å°Tracesä¿¡æ¯ï¼Œä»è€Œæ¥ç»˜åˆ¶ä¸€å¸§ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackRecord</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> CallbackRecord next;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">long</span> dueTime;</div><div class="line">    <span class="keyword">public</span> Object action; <span class="comment">// Runnable or FrameCallback</span></div><div class="line">    <span class="keyword">public</span> Object token;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">long</span> frameTimeNanos)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (token == FRAME_CALLBACK_TOKEN) &#123;</div><div class="line">            ((FrameCallback)action).doFrame(frameTimeNanos);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ((Runnable)action).run();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CallbackQueue</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> CallbackRecord mHead;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasDueCallbacksLocked</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mHead != <span class="keyword">null</span> &amp;&amp; mHead.dueTime &lt;= now;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> CallbackRecord <span class="title">extractDueCallbacksLocked</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</div><div class="line">        CallbackRecord callbacks = mHead;</div><div class="line">        <span class="keyword">if</span> (callbacks == <span class="keyword">null</span> || callbacks.dueTime &gt; now) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        CallbackRecord last = callbacks;</div><div class="line">        CallbackRecord next = last.next;</div><div class="line">        <span class="keyword">while</span> (next != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (next.dueTime &gt; now) &#123;</div><div class="line">                last.next = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            last = next;</div><div class="line">            next = next.next;</div><div class="line">        &#125;</div><div class="line">        mHead = next;</div><div class="line">        <span class="keyword">return</span> callbacks;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addCallbackLocked</span><span class="params">(<span class="keyword">long</span> dueTime, Object action, Object token)</span> </span>&#123;</div><div class="line">        CallbackRecord callback = obtainCallbackLocked(dueTime, action, token);</div><div class="line">        CallbackRecord entry = mHead;</div><div class="line">        <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</div><div class="line">            mHead = callback;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (dueTime &lt; entry.dueTime) &#123;</div><div class="line">            callback.next = entry;</div><div class="line">            mHead = callback;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">while</span> (entry.next != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (dueTime &lt; entry.next.dueTime) &#123;</div><div class="line">                callback.next = entry.next;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            entry = entry.next;</div><div class="line">        &#125;</div><div class="line">        entry.next = callback;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeCallbacksLocked</span><span class="params">(Object action, Object token)</span> </span>&#123;</div><div class="line">        CallbackRecord predecessor = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">for</span> (CallbackRecord callback = mHead; callback != <span class="keyword">null</span>;) &#123;</div><div class="line">            <span class="keyword">final</span> CallbackRecord next = callback.next;</div><div class="line">            <span class="keyword">if</span> ((action == <span class="keyword">null</span> || callback.action == action)</div><div class="line">                    &amp;&amp; (token == <span class="keyword">null</span> || callback.token == token)) &#123;</div><div class="line">                <span class="keyword">if</span> (predecessor != <span class="keyword">null</span>) &#123;</div><div class="line">                    predecessor.next = next;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mHead = next;</div><div class="line">                &#125;</div><div class="line">                recycleCallbackLocked(callback);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                predecessor = callback;</div><div class="line">            &#125;</div><div class="line">            callback = next;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>CallbackQueue and CallbackRecord</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postCallbackDelayedInternal</span><span class="params">(<span class="keyword">int</span> callbackType,</span></span></div><div class="line">            Object action, Object token, <span class="keyword">long</span> delayMillis) &#123;</div><div class="line">    <span class="keyword">if</span> (DEBUG_FRAMES) &#123;</div><div class="line">        Log.d(TAG, <span class="string">"PostCallback: type="</span> + callbackType</div><div class="line">                + <span class="string">", action="</span> + action + <span class="string">", token="</span> + token</div><div class="line">                + <span class="string">", delayMillis="</span> + delayMillis);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> dueTime = now + delayMillis;</div><div class="line">        mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (dueTime &lt;= now) &#123;</div><div class="line">            scheduleFrameLocked(now);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action);</div><div class="line">            msg.arg1 = callbackType;</div><div class="line">            msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">            mHandler.sendMessageAtTime(msg, dueTime);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>postCallbackDelayedInternal<br>å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬æŠŠæˆ‘ä»¬çš„ç»˜åˆ¶å†…å®¹æ‰”åˆ°é˜Ÿåˆ—é‡Œï¼Œç­‰å¾…è½®è®­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">FrameDisplayEventReceiver</span> <span class="keyword">extends</span> <span class="title">DisplayEventReceiver</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">Runnable</span> &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHavePendingVsync;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mTimestampNanos;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFrame;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FrameDisplayEventReceiver</span><span class="params">(Looper looper)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(looper);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onVsync</span><span class="params">(<span class="keyword">long</span> timestampNanos, <span class="keyword">int</span> builtInDisplayId, <span class="keyword">int</span> frame)</span> </span>&#123;</div><div class="line">        <span class="comment">// Ignore vsync from secondary display.</span></div><div class="line">        <span class="comment">// This can be problematic because the call to scheduleVsync() is a one-shot.</span></div><div class="line">        <span class="comment">// We need to ensure that we will still receive the vsync from the primary</span></div><div class="line">        <span class="comment">// display which is the one we really care about.  Ideally we should schedule</span></div><div class="line">        <span class="comment">// vsync for a particular display.</span></div><div class="line">        <span class="comment">// At this time Surface Flinger won't send us vsyncs for secondary displays</span></div><div class="line">        <span class="comment">// but that could change in the future so let's log a message to help us remember</span></div><div class="line">        <span class="comment">// that we need to fix this.</span></div><div class="line">        <span class="keyword">if</span> (builtInDisplayId != SurfaceControl.BUILT_IN_DISPLAY_ID_MAIN) &#123;</div><div class="line">            Log.d(TAG, <span class="string">"Received vsync from secondary display, but we don't support "</span></div><div class="line">                    + <span class="string">"this case yet.  Choreographer needs a way to explicitly request "</span></div><div class="line">                    + <span class="string">"vsync for a specific display to ensure it doesn't lose track "</span></div><div class="line">                    + <span class="string">"of its scheduled vsync."</span>);</div><div class="line">            scheduleVsync();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Post the vsync event to the Handler.</span></div><div class="line">        <span class="comment">// The idea is to prevent incoming vsync events from completely starving</span></div><div class="line">        <span class="comment">// the message queue.  If there are no messages in the queue with timestamps</span></div><div class="line">        <span class="comment">// earlier than the frame time, then the vsync event will be processed immediately.</span></div><div class="line">        <span class="comment">// Otherwise, messages that predate the vsync event will be handled first.</span></div><div class="line">        <span class="keyword">long</span> now = System.nanoTime();</div><div class="line">        <span class="keyword">if</span> (timestampNanos &gt; now) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"Frame time is "</span> + ((timestampNanos - now) * <span class="number">0.000001f</span>)</div><div class="line">                    + <span class="string">" ms in the future!  Check that graphics HAL is generating vsync "</span></div><div class="line">                    + <span class="string">"timestamps using the correct timebase."</span>);</div><div class="line">            timestampNanos = now;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (mHavePendingVsync) &#123;</div><div class="line">            Log.w(TAG, <span class="string">"Already have a pending vsync event.  There should only be "</span></div><div class="line">                    + <span class="string">"one at a time."</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mHavePendingVsync = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        mTimestampNanos = timestampNanos;</div><div class="line">        mFrame = frame;</div><div class="line">        Message msg = Message.obtain(mHandler, <span class="keyword">this</span>);</div><div class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</div><div class="line">        mHandler.sendMessageAtTime(msg, timestampNanos / TimeUtils.NANOS_PER_MS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        mHavePendingVsync = <span class="keyword">false</span>;</div><div class="line">        doFrame(mTimestampNanos, mFrame);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FrameDisplayEventReceiver<br>æ¥æ”¶æ—¶é’Ÿè„‰å†²ä¿¡å·çš„å¹¿æ’­ï¼Œ16msä¸€æ¬¡ï¼Œæˆ‘ä»¬çš„ç›®çš„å°±æ˜¯åœ¨è¿™ä¸ªæ—¶é’Ÿè„‰å†²é‡Œæå®šæ•´ä¸ª view</p>
<h3 id="Android-åŠ¨ç”»"><a href="#Android-åŠ¨ç”»" class="headerlink" title="Android åŠ¨ç”»"></a>Android åŠ¨ç”»</h3><p>Animatorï¼ŒScrollToï¼ŒoffsetLeftAndRightï¼Œè¿™é‡Œé¢æˆ‘ä»¬å…ˆå•åˆ—è¿™å‡ é¡¹ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªåŸç†ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¤§èƒ†çš„çŒœæƒ³ï¼Œä¸€å®šæ˜¯é¢‘ç¹æ‰§è¡Œæˆ‘ä»¬çš„ Choreographer.CallBack æ¥ç»˜åˆ¶ï¼Œå› ä¸ºåªè¦åœ¨16mså†…ç»˜åˆ¶æˆåŠŸï¼Œé‚£å°±æ˜¯æµç•…çš„åŠ¨ç”»ã€‚ä¸‹é¢æˆ‘ä»¬éªŒè¯ä¸€ä¸‹</p>
<p>ScrollTo:</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ View ä¸­è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scrollTo</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mScrollX != x || mScrollY != y) &#123;</div><div class="line">        <span class="keyword">int</span> oldX = mScrollX;</div><div class="line">        <span class="keyword">int</span> oldY = mScrollY;</div><div class="line">        mScrollX = x;</div><div class="line">        mScrollY = y;</div><div class="line">        invalidateParentCaches();</div><div class="line">        onScrollChanged(mScrollX, mScrollY, oldX, oldY);</div><div class="line">        <span class="keyword">if</span> (!awakenScrollBars()) &#123;</div><div class="line">            postInvalidateOnAnimation();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>scrollTo<br>å¾ˆç®€å•ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥çœ‹æ‡‚ï¼Œå¼€å§‹ä½ç½®ï¼Œç»“æŸä½ç½®ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ postInvalidateOnAnimation()  è¿™ä¸ªæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postInvalidateOnAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// We try only with the AttachInfo because there's no point in invalidating</span></div><div class="line">    <span class="comment">// if we are not attached to our window</span></div><div class="line">    <span class="keyword">final</span> AttachInfo attachInfo = mAttachInfo;</div><div class="line">    <span class="keyword">if</span> (attachInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        attachInfo.mViewRootImpl.dispatchInvalidateOnAnimation(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>postInvalidateOnAnimation<br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„åŠ¨ç”»è¿‡ç¨‹ç»˜åˆ¶ä»–è¿˜æ˜¯æ‰”åˆ°äº†ViewRootImpl ä»£ç†åšè¿™ä»¶äº‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchInvalidateRectOnAnimation</span><span class="params">(AttachInfo.InvalidateInfo info)</span> </span>&#123;</div><div class="line">    mInvalidateOnAnimationRunnable.addViewRect(info);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>dispatchInvalidateOnAnimation<br>è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°ä»–å¼€äº†ä¸ªçº¿ç¨‹ mInvalidateOnAnimationRunnable å»æ·»åŠ æˆ‘ä»¬è¿™ä¸ªå°†è¦ç»˜åˆ¶çš„ viewï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åº–ä¸è§£ç‰›</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InvalidateOnAnimationRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mPosted;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;View&gt; mViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;AttachInfo.InvalidateInfo&gt; mViewRects =</div><div class="line">            <span class="keyword">new</span> ArrayList&lt;AttachInfo.InvalidateInfo&gt;();</div><div class="line">    <span class="keyword">private</span> View[] mTempViews;</div><div class="line">    <span class="keyword">private</span> AttachInfo.InvalidateInfo[] mTempViewRects;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            mViews.add(view);</div><div class="line">            postIfNeededLocked();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addViewRect</span><span class="params">(AttachInfo.InvalidateInfo info)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            mViewRects.add(info);</div><div class="line">            postIfNeededLocked();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            mViews.remove(view);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = mViewRects.size(); i-- &gt; <span class="number">0</span>; ) &#123;</div><div class="line">                AttachInfo.InvalidateInfo info = mViewRects.get(i);</div><div class="line">                <span class="keyword">if</span> (info.target == view) &#123;</div><div class="line">                    mViewRects.remove(i);</div><div class="line">                    info.recycle();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (mPosted &amp;&amp; mViews.isEmpty() &amp;&amp; mViewRects.isEmpty()) &#123;</div><div class="line">                mChoreographer.removeCallbacks(Choreographer.CALLBACK_ANIMATION, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">                mPosted = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> viewCount;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> viewRectCount;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            mPosted = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">            viewCount = mViews.size();</div><div class="line">            <span class="keyword">if</span> (viewCount != <span class="number">0</span>) &#123;</div><div class="line">                mTempViews = mViews.toArray(mTempViews != <span class="keyword">null</span></div><div class="line">                        ? mTempViews : <span class="keyword">new</span> View[viewCount]);</div><div class="line">                mViews.clear();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            viewRectCount = mViewRects.size();</div><div class="line">            <span class="keyword">if</span> (viewRectCount != <span class="number">0</span>) &#123;</div><div class="line">                mTempViewRects = mViewRects.toArray(mTempViewRects != <span class="keyword">null</span></div><div class="line">                        ? mTempViewRects : <span class="keyword">new</span> AttachInfo.InvalidateInfo[viewRectCount]);</div><div class="line">                mViewRects.clear();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewCount; i++) &#123;</div><div class="line">            mTempViews[i].invalidate();</div><div class="line">            mTempViews[i] = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; viewRectCount; i++) &#123;</div><div class="line">            <span class="keyword">final</span> View.AttachInfo.InvalidateInfo info = mTempViewRects[i];</div><div class="line">            info.target.invalidate(info.left, info.top, info.right, info.bottom);</div><div class="line">            info.recycle();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postIfNeededLocked</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!mPosted) &#123;</div><div class="line">            mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, <span class="keyword">this</span>, <span class="keyword">null</span>);</div><div class="line">            mPosted = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>InvalidateOnAnimationRunnable<br>ç»ˆäºï¼Œåº”äº†æˆ‘ä»¬çš„çŒœæƒ³ï¼ŒViewRootImpl æœ‰ä¸€ä¸ªä¸“é—¨æ‰§è¡ŒåŠ¨ç”»ç»˜åˆ¶æ“ä½œçš„çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° run() é‡Œé¢ä¸æ–­åœ°CallBackï¼Œç„¶åå›æ”¶ï¼Œå½“ç„¶é‡Œé¢æœ‰äº›çº¿ç¨‹é”å•¥çš„ä¸æ¶‰åŠæœ¬æ–‡å°±ä¸ç»†è¯´äº†ã€‚</p>
<h3 id="ValueAnimatorï¼š"><a href="#ValueAnimatorï¼š" class="headerlink" title="ValueAnimatorï¼š"></a>ValueAnimatorï¼š</h3><p>è¿™é‡Œæˆ‘ä»¬æœ‰ä¸ª AnimationHandler æ¥æ‰§è¡ŒåŠ¨ç”»æ“ä½œï¼Œè¿™å…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numAnims; ++i) &#123;</div><div class="line">    ValueAnimator anim = mTmpAnimations.get(i);</div><div class="line">    <span class="keyword">if</span> (mAnimations.contains(anim) &amp;&amp; anim.doAnimationFrame(frameTime)) &#123;</div><div class="line">        mEndingAnims.add(anim);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">mTmpAnimations.clear();</div></pre></td></tr></table></figure>
<p>doAnimationFrame<br>è¿™é‡Œåœ¨ä¸æ–­å¾ªç¯æˆ‘ä»¬æ‰€æœ‰çš„animï¼Œå¹¶åœ¨ä¸æ–­æ‰§è¡Œ scheduleAnimation æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleAnimation</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!mAnimationScheduled) &#123;</div><div class="line">        mChoreographer.postCallback(Choreographer.CALLBACK_ANIMATION, mAnimate, <span class="keyword">null</span>);</div><div class="line">        mAnimationScheduled = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>scheduleAnimation<br>å‰©ä¸‹çš„å¤§å®¶è‡ªå·±ç¿»é˜…æºç æŠŠã€‚</p>
<p>è¿™é‡Œæ€»ç»“ä¸€ä¸‹ã€‚æˆ‘ä»¬æ‰€æœ‰ç•Œé¢ä¸Šè§†å›¾çš„å˜åŒ–éƒ½æ˜¯éƒ½æ˜¯ ViewRootImpl æŠŠéœ€è¦é‡ç»˜çš„ä¸œè¥¿å¡«å…… Choreographer ä¸­çš„ mCallbackQueues é˜Ÿåˆ—ï¼Œç„¶ååœ¨æ—¶é’Ÿè„‰å†²çš„å¹¿æ’­ä¸‹è¿›è¡Œè½®è®­æ‰§è¡Œã€‚</p>
<p>æ—¢ç„¶æåˆ°é˜Ÿåˆ—ï¼Œå‡å¦‚æˆ‘ä»¬åœ¨16mså†…å¤§é‡çš„å¡«å…… AttachInfo ä¹‹ç±»çš„ç»˜åˆ¶OBJï¼Œå°±ä¼šå¯¼è‡´æ— æ³•å†ä¸€æ¬¡æ—¶é’Ÿè„‰å†²å†…ç»˜åˆ¶å®Œæ¯•ï¼Œå°±ä¼šåœ¨é€ æˆä¸¢å¸§ï¼ŒUIé˜»å¡ã€‚</p>
<p>é¿å… Android UI å¡é¡¿è§£å†³åŠæ³•</p>
<p>è§£å†³åŠæ³•ï¼šåˆ†æäº†å¥½å¤šï¼Œè¿™é‡Œè¯´ä¸¤ä¸ªæ–¹æ³•ã€‚</p>
<p>1.é¿å…é‡ç»˜ï¼Œè¿™é‡Œé¿å…å›¾å±‚ï¼ˆViewï¼‰è¿­ä»£ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥å»å¼€å‘è€…æ¨¡å¼ä¸­å¯¹â€œæ˜¾ç¤ºGPUè§†å›¾æ›´æ–°â€æ‰“é’©</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2710533-cade3554a7db68ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Alt text"></p>
<p>è¿‡åº¦ç»˜åˆ¶</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2710533-eb07b0f9a442d6f3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Alt text"></p>
<p>ä¼˜åŒ–ä»¥å<br>è¿™é‡Œå¼•ç”¨ <a href="http://hukai.me/android-performance-render" target="_blank" rel="external">http://hukai.me/android-performance-render</a> è¿™ç¯‡åšå®¢çš„ä½œè€…ï¼Œç›—ä¸ªå›¾ã€‚ğŸ˜‚</p>
<p>è¿™é‡Œå¯ä»¥è¿›è¡Œï¼Œé€‰æ‹©åˆ¶å®šç”»å¸ƒç»˜åˆ¶ï¼Œè€Œä¸æ˜¯æ•´ä¸ªviewå»ç»˜åˆ¶ã€‚å¯ä»¥åœ¨onDrawä¸­è¿›è¡Œé™åˆ¶ï¼Œå»é™åˆ¶ç»˜åˆ¶åŒºåŸŸï¼Œä¾‹å¦‚</p>
<p>canvas.clipRect(100,100,350,600, Region.Op.INTERSECT);</p>
<p>2.æ‰å¹³åŒ–å¸ƒå±€ï¼Œå½’æ ¹ç»“åº•ä¹Ÿæ˜¯å‡å°‘ mCallbackQueues é˜Ÿåˆ—å¤§å°ã€‚ä¿è¯å°½é‡åœ¨16mså†…ç»˜åˆ¶å®Œæ¯•ï¼Œå†æœ‰å°±æ˜¯å¯ä»¥å‡å°‘è§†å›¾ ViewTree çš„é«˜åº¦ï¼Œå‡å°‘æ—¶é—´å¤æ‚åº¦ï¼Œä»è€Œä¼˜åŒ–è®¡ç®—è¿‡ç¨‹</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2710533-4c8e729db92f694a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Alt text"></p>
<p>xmlä»£ç </p>
<p><img src="http://upload-images.jianshu.io/upload_images/2710533-0dbcc3353bd36d2f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Alt text"></p>
<p>ä¼˜åŒ–åçš„xmlä»£ç <br>ï¼Šé™„ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/2710533-5ddc05554c24d6d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Alt text"></p>
<p>ç»˜åˆ¶å±‚çº§<br>é€šè¿‡æ‰“å¼€åˆšæ‰è¯´çš„å¼€å‘è€…é€‰é¡¹ï¼Œæ¥æ ¹æ®é¢œè‰²æ¥åˆ¤æ–­é¡µé¢ç»˜åˆ¶æƒ…å†µã€‚</p>
<p>è·ç¦»å›å®¶è¿˜æœ‰8 ä¸ªå°æ—¶ï¼Œ17å¹´å¸Œæœ›å¯ä»¥å‘è§‰æ›´å¤šçš„ä¸œè¥¿ç»™å¤§å®¶ï¼Œå¹¶ä¸”å¸Œæœ›å¤§å®¶å¯ä»¥ç§¯ææŒ‡å‡ºæ–‡ç« ä¸­çš„é”™è¯¯ã€‚ç¥å¤§å®¶æ–°å¹´å¿«ä¹ï¼ğŸ˜„</p>
]]></content>
      
        
        <tags>
            
            <tag> Android æºç  </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Dagger2ä½“ä¼š]]></title>
      <url>/2016/08/11/Dagger2%E4%BD%93%E4%BC%9A/</url>
      <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘åˆšæ¥æˆ‘å¸ï¼Œå¼€å§‹å…¥æ‰‹å…¬å¸çš„é¡¹ç›®ï¼ŒMVPï¼ŒRxJavaï¼ŒDagger2æ­å»ºçš„æ¡†æ¶ã€‚å¯¹äºæˆ‘è¿™ä¸ªåˆšæ²¡å¤šé•¿æ—¶é—´çš„Androidèœé¸Ÿï¼Œç€å®èŠ±äº†ä¸€æ®µæ—¶é—´ï¼Œè¯´ç‚¹å„¿é¢˜å¤–è¯ï¼Œæœ€è¿‘ç ”ç©¶äº†Java8ï¼Œå·²ç»å¼€å§‹ç”±å‘½ä»¤å¼ç¼–ç¨‹è¿‡åº¦åˆ°å‡½æ•°å¼ç¼–ç¨‹äº†ï¼Œå°¤å…¶æ˜¯åŠ äº†Lambdaè¡¨è¾¾å¼ï¼Œé…èµ·æ¥RxJavaçš„åˆ‡æ¢çº¿ç¨‹ï¼Œå¼‚æ­¥æ“ä½œçˆ½å‘†äº†ã€‚</p>
<p>è‡³äºMVPï¼Œå¼€å§‹æˆ‘æ˜¯åªçŸ¥é“MVCï¼Œä½†åœ¨çœ‹æˆ‘å¸çš„é¡¹ç›®æ¶æ„çš„æ—¶å€™å‘ç°æœ‰å·®åˆ«ï¼Œåæ¥åœ¨ç®€ä¹¦ä¸Šçœ‹åˆ°ä¸€ä¸ªåšä¸»ï¼Œé†é†çŒé¡¶ï¼Œæ˜ç™½äº†MVPå…¶å®è·ŸMVCæ˜¯ä¸ä¸€æ ·çš„ï¼Œå°±å•å•Modelæ¥è¯´ï¼Œåœ¨MVCä¸­åªæ˜¯æˆ‘ä»¬çš„ä¸€äº›javaBeanï¼Œè€Œåœ¨MVPå®ƒæ¶‰åŠåˆ°æ•°æ®çš„æ¥é¾™å»è„‰ï¼Œæ•°æ®æ˜¯æ¥è‡ªå†…å­˜ï¼Œç¡¬ç›˜ï¼Œè¿˜æ˜¯ç½‘ç»œã€‚å·²ç»æ•°æ®å°†ä¼šæ€æ ·å­˜å‚¨éƒ½åŒ…å«å…¶ä¸­ï¼Œè‡³äºMVçš„ä¸åŒï¼Œè¯·å¤§å®¶çœ‹<a href="https://hexo.io/" target="_blank" rel="external">MVP</a>ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è¿™ç¯‡åšå®¢çš„é‡ç‚¹äº†ï¼ŒDagger2ï¼Œç›¸ä¿¡å¤§å®¶éƒ½æˆ–å¤šæˆ–å°‘ç”¨è¿‡æˆ–è€…å¬è¯´è¿‡ã€‚è®©å¤§å®¶æ´¥æ´¥ä¹é“çš„å°±æ˜¯å®ƒçš„ä¾èµ–æ³¨å…¥ï¼Œä¹‹å‰æœ‰ç­è§£è¿‡ä¾èµ–æ³¨å…¥ï¼ŒçŸ¥é“ä»–æœ€å¤§çš„å¥½å¤„æ˜¯è§£è—•ï¼Œå¤§å­¦æ—¶å€™æ²¡å¥½å¥½ç ”ç©¶ï¼Œä»Šå¤©æˆ‘æƒ³è¯´ä¸€ä¸‹æˆ‘çš„å¿ƒå¾—ã€‚</p>
<h2 id="å‡ ä¸ªç–‘é—®"><a href="#å‡ ä¸ªç–‘é—®" class="headerlink" title="å‡ ä¸ªç–‘é—®"></a>å‡ ä¸ªç–‘é—®</h2><h3 id="ä»€ä¹ˆæ˜¯è§£è€¦ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯è§£è€¦ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯è§£è€¦ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯è§£è€¦ï¼Ÿ</h3><p>è§£è€¦å°±æ˜¯æ¾è€¦åˆï¼Œåœ¨æˆ‘ä»¬å¼€å§‹å­¦Javaçš„æ—¶å€™newè¿‡å„ç§äº‹ç‰©ï¼Œ(PSä¸–é—´ä¸‡ç‰©çš†å¯¹è±¡)ï¼Œä½†å½“å·¥ç¨‹å˜å¤§ï¼Œä½ çš„javaæ–‡ä»¶è¿‡å¤šï¼Œä¸€æ—¦éœ€æ±‚å¦¹å¦¹è¿‡æ¥è·Ÿä½ å¨‡æ»´æ»´çš„è¯´ï¼Œæ„é€ å‡½æ•°åŠ ä¸ªå‚æ•°å‘—ï¼Œæ¯•ç«Ÿæ˜¯å¦¹å­æ±‚ï¼Œæ€èƒ½ä¸ä»ï¼Œç„¶åä½ å¼€å§‹æ˜å¤©é»‘åœ°çš„æ‰¾ï¼Œè¿™ç§æœ€ç›´è§‚çš„ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«çš„ä½“éªŒå°±æ˜¯è€¦åˆï¼Œå¾ˆç›´è§‚å§ã€‚å®˜æ–¹çš„è¯´æ³•å°±æ˜¯ï¼Œåœ¨Aä¸­new Bè¿åäº†å•ä¸€èŒè´£åŸåˆ™ï¼ŒB åªèƒ½åœ¨Aä¸­newï¼Œè¿åäº†å¼€é—­åŸåˆ™ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å¼±åŒ–è¿™ç§å…³ç³»ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ</h3><p>é‚£ä¹ˆä¾èµ–æ³¨å…¥è¿™ä¸ªæ€æƒ³æ˜¯ä»€ä¹ˆé‚£ï¼Œå‡è®¾Aéœ€è¦Bï¼Œæˆ‘ä»¬è¦åšçš„ä¸æ˜¯ç¡¬ç¼–ç new Bï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå·¥å‚å»ç”Ÿäº§å®ƒï¼Œä½ çœ‹åˆ°è¿™ä¸€å®šè’™è”½äº†ï¼Œå·¥å‚ä¸ä¹Ÿå¾—newå—ï¼Œè®²é“ç†ï¼Œæ˜¯è¿™æ ·ï¼Œä½†ä½ æƒ³ï¼Œå½“ä½ æƒ³æ”¹Bçš„æœ‰å‚æ„é€ æˆ–æ˜¯å…¶ä»–ï¼Œä½ åªéœ€è¦æ”¹ä»–çš„å·¥å‚ã€‚è®¾è®¡æ¨¡å¼å°±æ˜¯è¿™æ ·ï¼Œä½ å¯èƒ½ä¼šæ„Ÿè§‰ï¼Œå¥½éº»çƒ¦å•Šï¼Œæˆ‘å¼€å§‹ä¹Ÿæ˜¯è¿™æ ·ï¼Œè§‰å¾—æ˜æ˜å‡ è¡Œï¼Œä¸ºä»€ä¹ˆç”¨äº†è®¾è®¡æ¨¡å¼ä¼šè¿™ä¹ˆå¤šä»£ç ã€‚æ‹…å½“å¼€å§‹æ¥æ”¶é¡¹ç›®ï¼Œä½ ä¼šæ„Ÿè§‰è‡ªå·±çš„ä»£ç è¶Šå†™è¶Šéš¾ä»¥ç»´æŠ¤ï¼Œè—•åˆåº¦è¶Šé«˜ï¼Œæœ€ç›´è§‚çš„æ„Ÿå—ï¼Œå†™çš„è‡ªå·±éƒ½å¿ƒåŠ›äº¤ç˜ï¼Œç‰µä¸€å‘åŠ¨å…¨èº«ï¼Œå¥½äº†ï¼Œå›å½’æ­£é¢˜ï¼Œè®¾æƒ³å‡å¦‚ä½ åœ¨100ä¸ªç±»é‡Œé¢new äº†Bï¼Œå½“Bæ”¹å˜çš„æ—¶å€™ä½ æ˜¯ä¸æ˜¯è¦å»ä¸€ä¸ªä¸ªæ”¹ï¼Œä½†æ˜¯å‡å¦‚ä½ åªæ˜¯ä¿®æ”¹ä»–çš„å·¥å‚é‚£å°±ä¸ç”¨äº†ï¼Œå› ä¸ºB çš„æºå¤´æ˜¯ä½ åœ¨ç”¨åˆ°å®ƒçš„æ—¶å€™ç”±å·¥å‚æ³¨å…¥ï¼Œæ— è®ºæ˜¯åˆå§‹åŒ–åŠ è½½ï¼Œè¿˜æ˜¯lazyåŠ è½½ï¼Œéƒ½ä¸€æ ·ã€‚</p>
<p>å…¶å®ä¾èµ–æ³¨å…¥æˆ‘ä»¬ä¸€å®šè§è¿‡ï¼Œè¿™é‡Œèšä¸€ä¸‹ä¾‹å­ï¼š</p>
<h4 id="æ„é€ å‡½æ•°"><a href="#æ„é€ å‡½æ•°" class="headerlink" title="æ„é€ å‡½æ•°"></a>æ„é€ å‡½æ•°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    B b;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">A</span><span class="params">(B b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="setæ–¹æ³•æ³¨å…¥"><a href="#setæ–¹æ³•æ³¨å…¥" class="headerlink" title="setæ–¹æ³•æ³¨å…¥"></a>setæ–¹æ³•æ³¨å…¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    B b;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setB</span><span class="params">(B b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ¥å£æ³¨å…¥"><a href="#æ¥å£æ³¨å…¥" class="headerlink" title="æ¥å£æ³¨å…¥"></a>æ¥å£æ³¨å…¥</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">InjectInterface</span>() </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InjectB</span><span class="params">(B b)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> <span class="keyword">implements</span> <span class="title">InjectInterface</span> </span>&#123;</div><div class="line">    B b;</div><div class="line">    <span class="meta">@override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">InjectB</span><span class="params">(B b)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.b = b;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="æ³¨è§£æ–¹å¼-ä¹Ÿæ˜¯Daggeræ¡†æ¶çš„ä¸»è¦æ–¹å¼"><a href="#æ³¨è§£æ–¹å¼-ä¹Ÿæ˜¯Daggeræ¡†æ¶çš„ä¸»è¦æ–¹å¼" class="headerlink" title="æ³¨è§£æ–¹å¼(ä¹Ÿæ˜¯Daggeræ¡†æ¶çš„ä¸»è¦æ–¹å¼)"></a>æ³¨è§£æ–¹å¼(ä¹Ÿæ˜¯Daggeræ¡†æ¶çš„ä¸»è¦æ–¹å¼)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    B b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å…³äºDagger2çš„ä¾èµ–æ³¨å…¥ï¼Ÿ"><a href="#å…³äºDagger2çš„ä¾èµ–æ³¨å…¥ï¼Ÿ" class="headerlink" title="å…³äºDagger2çš„ä¾èµ–æ³¨å…¥ï¼Ÿ"></a>å…³äºDagger2çš„ä¾èµ–æ³¨å…¥ï¼Ÿ</h3><p>okï¼Œæˆ‘è§‰å¾—ä»–æµå¼Šçš„åœ°æ–¹æ˜¯è®¾è®¡æ€æƒ³ã€‚daggerçš„æœ€ç»ˆç›®çš„æ˜¯ä¾èµ–æ³¨å…¥ï¼Œæ˜¯è§£è€¦ï¼Œä½†æ˜¯ä»–çš„å®ç°æ–¹æ³•å¾ˆæµå¼Šã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥èŠä¸€èŠä»–çš„å‡ ä¸ªkeywords: Injectï¼ŒComponentï¼ŒModuleï¼ŒProvidesï¼Œè¿™é‡Œå…è®¸æˆ‘ç›—ä¸€å¼ å›¾(ps: <a href="http://www.jianshu.com/p/cd2c1c9f68d4" target="_blank" rel="external">å›¾çš„æ¥æº</a>, è¿™ç¯‡æ–‡ç« çš„ä½œè€…å°±æ˜¯ä¸Šé¢çš„MVPçš„ä½œè€…ã€‚éå¸¸æ„Ÿè°¢å¤§å“¥ï¼Œä¹‹å‰ä¹Ÿè¯¦ç»†è§£ç­”äº†æˆ‘å¾ˆå¤š)</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1504173-0b81f8a57768a703.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="å…³ç³»å›¾"></p>
<h4 id="Inject"><a href="#Inject" class="headerlink" title="Inject:"></a>Inject:</h4><p>ä¸¤ä¸ªä½œç”¨:</p>
<p>1.æ ‡è¯†å“ªé‡Œéœ€è¦è¢«æ³¨å…¥ã€‚</p>
<p>2.æ ‡è¯†å“ªé‡Œå¯ä»¥æä¾›æ³¨å…¥ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="comment">// è¿™é‡Œéœ€è¦è¢«æ³¨å…¥</span></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    B b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">    <span class="comment">// æä¾›æ³¨å…¥</span></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    B() &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Commponent"><a href="#Commponent" class="headerlink" title="Commponent"></a>Commponent</h4><p>å­—é¢ç†è§£å°±æ˜¯ä¸»æŒäººï¼Œå®ƒæ›´åƒæ˜¯æˆ‘ä»¬çš„åˆ†å‘å™¨ã€‚å‘è´Ÿè´£å¾—åˆ°Bçš„å®ä¾‹ï¼Œå¹¶å»ç»™è¢«æ ‡è¯†æ³¨å…¥çš„åœ°æ–¹è¿›è¡Œæ³¨å…¥ã€‚å®šç‚¹æŠ•æ”¾ã€‚æ­£æ‰€è°“æ¥é¾™å»è„‰çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦Commponentæ¥å®ç°è¿™ä¸ªæ³¨å…¥è¿‡ç¨‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</div><div class="line">    <span class="comment">// æä¾›æ³¨å…¥</span></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    B() &#123;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="comment">// è¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ‰¾åˆ°Bçš„å®ä¾‹è¿›è¡Œæ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯éœ€è¦Commponentæ¥å»ºç«‹è”ç³»</span></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    B b;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@Commponent</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Commponent</span> </span>&#123;</div><div class="line">    <span class="comment">// è¿™å°±æ˜¯è®©Aï¼ŒBå‘ç”Ÿè”ç³»çš„åœ°æ–¹</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Inject</span><span class="params">(A a)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹Class A</span></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="comment">// è¿™é‡Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ‰¾åˆ°Bçš„å®ä¾‹è¿›è¡Œæ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯éœ€è¦Commponentæ¥å»ºç«‹è”ç³»</span></div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    B b;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">A</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Dagger2 è‡ªåŠ¨ç”Ÿæˆçš„ç»„ä»¶ç”¨æ¥æ³¨å…¥ï¼Œè¿™æ ·ä¹Ÿå°±è®©Aï¼ŒBå»ºç«‹äº†è”ç³»</span></div><div class="line">        DaggerComponent.builder()</div><div class="line">                       .build()</div><div class="line">                       .inject(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h4><p>è®²åˆ°è¿™é‡Œï¼Œä½ ä¼šæƒ³ï¼Œæ—¢ç„¶ç›®æ ‡ï¼Œæ¥æºéƒ½ç”¨Injectæ³¨è§£äº†ï¼Œæ³¨å…¥å™¨Commponentä¹Ÿå·²ç»okäº†ï¼Œä¸ºä½•è¦ç”¨åˆ°Modelï¼Œå…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå‡å¦‚æˆ‘ä»¬é¡¹ç›®ç”¨ç¬¬ä¸‰æ–¹æˆ–è€…å…¬å¸å°è£…å¥½çš„ç±»åº“ï¼Œä½ ä¸å¯èƒ½æŒ‡æœ›ä½ å»æ‰“å¼€å®ƒå»ä¿®æ”¹ï¼Œåœ¨ä½ éœ€è¦çš„ä½ç½®åŠ ä¸ŠInjectï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨Modelï¼Œå°†ç¬¬ä¸‰æ–¹æˆ‘ä»¬éœ€è¦çš„ç±»æš´éœ²å‡ºæ¥ã€‚Moduleå…¶å®æ˜¯ä¸€ä¸ªç®€å•å·¥å‚æ¨¡å¼ï¼ŒModuleé‡Œé¢çš„æ–¹æ³•åŸºæœ¬éƒ½æ˜¯åˆ›å»ºç±»å®ä¾‹çš„æ–¹æ³•ã€‚<br>è¿˜æ˜¯ä¸Šä»£ç æ¸…æ™°ä¸€äº›:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Model</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="comment">// B ä¸ºæˆ‘ä»¬ç¬¬ä¸‰æ–¹libä¸­çš„ç±»</span></div><div class="line">    <span class="function">B <span class="title">ProduceB</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> B();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç„¶è€Œè¿™æ ·å¹¶æ²¡æœ‰å®Œæˆï¼ŒModelä»…ä»…æ˜¯åˆ›å»ºå®ä¾‹çš„æ–¹æ³•ï¼Œæˆ‘æ²¡è¿˜æ²¡æœ‰è®©ä»–è·Ÿæˆ‘çš„Componentå‘ç”Ÿè”ç³»ï¼Œæˆ‘ä»¬éœ€è¦Modelå¯ä»¥è·Ÿæˆ‘ä¹‹å‰Injectéœ€è¦æ³¨å…¥çš„åœ°æ–¹å‘ç”Ÿè”ç³»ï¼Œæ¥ä¸‹æ¥å°±å¼•å‡ºæ¥æˆ‘ä¸‹é¢çš„keyword: Provides</p>
<h4 id="Provides"><a href="#Provides" class="headerlink" title="Provides"></a>Provides</h4><p>æ¥ç€æˆ‘ä»¬ä¸Šé¢çš„è¯é¢˜ï¼Œä¸è¦åœã€‚ä¸Šé¢è¯´åˆ°æˆ‘ä»¬éœ€è¦è®©æˆ‘çš„Modelè·Ÿæˆ‘ä»¬çš„Commponentå»ºç«‹è”ç³»ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æä¾›Providesæ ‡æ³¨æˆ‘ä»¬éœ€è¦çš„æ„é€ æ–¹æ³•ï¼Œè¿™æ ·å°±å®ç°äº†æˆ‘ä»¬çš„éœ€æ±‚ã€‚æ˜¯ä¸æ˜¯å¾ˆç¥å¥‡ã€‚ç„¶åæˆ‘ä»¬ç®€å•æ”¹ä¸€ä¸‹ä¸Šé¢çš„ä»£ç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Model</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</div><div class="line">    <span class="comment">// Providesæ¥æ ‡æ³¨</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="function">B <span class="title">ProduceB</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> B();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å…³äºModelï¼ŒInjectä¼˜å…ˆçº§ï¼Ÿ"><a href="#å…³äºModelï¼ŒInjectä¼˜å…ˆçº§ï¼Ÿ" class="headerlink" title="å…³äºModelï¼ŒInjectä¼˜å…ˆçº§ï¼Ÿ"></a>å…³äºModelï¼ŒInjectä¼˜å…ˆçº§ï¼Ÿ</h3><p>è¿™é‡ŒDagger2å¤„ç†çš„ä¼˜å…ˆçº§æ˜¯ï¼šModel &gt; Inject<br>ä¹Ÿå°±æ˜¯åœ¨åˆå§‹åŒ–æ„é€ çš„æ—¶å€™ï¼ŒDagger2ä¼šå…ˆå»æŸ¥æ‰¾Modelæœ‰æ²¡æœ‰Provideæˆ‘ä»¬éœ€è¦çš„æ„é€ æ–¹æ³•ï¼Œå‡å¦‚æ²¡æœ‰ï¼Œå®ƒä¼šå»æŸ¥æ‰¾Injectã€‚</p>
<h3 id="å…³äºæœ‰å‚æ— å‚çš„æ„é€ ï¼Ÿ"><a href="#å…³äºæœ‰å‚æ— å‚çš„æ„é€ ï¼Ÿ" class="headerlink" title="å…³äºæœ‰å‚æ— å‚çš„æ„é€ ï¼Ÿ"></a>å…³äºæœ‰å‚æ— å‚çš„æ„é€ ï¼Ÿ</h3><p>æ— å‚ç›´æ¥å°±createè¿™ä¸ªç±»ï¼Œæœ‰å‚å°±å»æŸ¥çœ‹@modelçš„@Provideï¼Œç„¶åå†æŸ¥ Inject æ¥æ„é€ æˆ‘ä»¬è¿™ä¸ªç±»éœ€è¦çš„æœ‰å‚æ„é€ çš„å‚æ•°ï¼Œè¿‡ç¨‹ä¸­å¦‚æœåˆå‘ç°è¿˜æœ‰éœ€è¦æ„é€ å‚æ•°çš„å°±ç»§ç»­æŸ¥@modelçš„@Provide  ç„¶åå†æŸ¥ Inject ä»¥æ­¤ç±»æ¨ã€‚</p>
<h2 id="ç®€å•æ€»ç»“"><a href="#ç®€å•æ€»ç»“" class="headerlink" title="ç®€å•æ€»ç»“"></a>ç®€å•æ€»ç»“</h2><p>Dagger2çš„å‡ºç°å¤§å¤§åŠ å¿«äº†Androidçš„MVPæ¨¡å¼çš„å¼€å‘ã€‚è€Œä»Šå¤©æˆ‘è¯´çš„æ˜¯åŸºç¡€æ–¹é¢çš„ï¼Œè‡³äºè¿˜æœ‰å¾ˆå¤šä¾‹å¦‚ Qualifierï¼ˆé™å®šç¬¦ï¼‰ã€Singletonï¼ˆå•ä¾‹ï¼‰ã€Scopeï¼ˆä½œç”¨åŸŸï¼‰ã€æˆ‘ä¼šåœ¨æ¥ä¸‹æ¥çš„Blogä¸­è¿›è¡Œåˆ†æï¼Œç”±è¡·åœ°å¸Œæœ›æœ‰çœ‹åˆ°è¿™ç¯‡åšå®¢çš„ç«¥é‹ï¼Œå‡å¦‚å‘ç°æˆ‘çš„ç†è§£æœ‰é—®é¢˜ï¼ŒåŠæ—¶çº æ­£æˆ‘ã€‚</p>
<p>æœ€åéƒ‘é‡å£°æ˜ï¼Œæ„Ÿè°¢<a href="http://www.jianshu.com/users/2ce7b74b592b/latest_articles" target="_blank" rel="external">ç‰›å¤§å“¥</a>.</p>
]]></content>
      
        
        <tags>
            
            <tag> Android ç¬¬ä¸‰æ–¹ </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
